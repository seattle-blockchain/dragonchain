FROM centos:7

RUN yum install -y epel-release

# General dependencies
RUN yum install -y \
      tar \
      m4 \
      perl \
      clang \
      gcc \
      gcc-c++ \
      git \
      libtool \
      autoconf \
      make \
      bison \
      bison-devel \
      flex

# C++ dependencies
RUN yum install -y \
      boost-devel-static \
      zlib-devel \
      openssl-devel \
      libevent-devel

# Python Dependencies
RUN yum install -y \
      python-devel \
      python-setuptools \
      python-six

# GLibC Dependencies
RUN yum install -y glib2-devel

# CMake
RUN curl -sSL https://cmake.org/files/v3.4/cmake-3.4.0.tar.gz | tar -xz && \
    cd cmake-3.4.0 && ./bootstrap && make -j4 && make install

# Clean up
RUN rm -rf /tmp/* && \
    yum clean all

ENV THRIFT_ROOT /var/thrift
RUN mkdir -p $THRIFT_ROOT
COPY ./thrift/ $THRIFT_ROOT

# Install PIP
RUN yum -y update
RUN yum -y install python-pip
RUN pip install --upgrade pip

RUN yum install -y epel-release
RUN yum -y install make automake gcc gcc-c++ kernel-devel
RUN yum -y install postgresql-libs
RUN yum -y install postgresql-devel
RUN pip install psycopg2
RUN echo $PATH

#Start processing
COPY blockchain blockchain/
COPY requirements.txt .
COPY setup.py .
COPY ./blockchain.yml .
COPY pki pki/

ARG BLOCKCHAIN_DB_HOSTNAME
ARG BLOCKCHAIN_DB_NAME
ARG BLOCKCHAIN_DB_USERNAME
ARG BLOCKCHAIN_DB_PORT

RUN pip install -r requirements.txt
RUN chmod a+x blockchain/processing.py
ENTRYPOINT ["python", "blockchain/processing.py --private-key pki/sk.pem --public-key pki/pk.pem --port 8080 --phase 1"]
